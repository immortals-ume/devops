# GitLab CI/CD Pipeline - Enhanced

stages:
  - validate
  - test
  - security
  - build
  - deploy-dev
  - deploy-staging
  - deploy-production

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  REGISTRY: $CI_REGISTRY
  IMAGE: $CI_REGISTRY_IMAGE
  KUBECONFIG: /tmp/kubeconfig

# Templates
.kubectl_config: &kubectl_config
  before_script:
    - mkdir -p $(dirname $KUBECONFIG)
    - echo "$KUBE_CONFIG" | base64 -d > $KUBECONFIG
    - export KUBECONFIG=$KUBECONFIG

.helm_config: &helm_config
  before_script:
    - curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
    - mkdir -p $(dirname $KUBECONFIG)
    - echo "$KUBE_CONFIG" | base64 -d > $KUBECONFIG
    - export KUBECONFIG=$KUBECONFIG

# Validate
validate:yaml:
  stage: validate
  image: alpine:latest
  before_script:
    - apk add --no-cache yamllint
  script:
    - yamllint -c .yamllint local/kubernetes/ local/helm-charts/ local/helmfile/
  allow_failure: true

validate:helm:
  stage: validate
  image: alpine/helm:latest
  script:
    - cd local/helm-charts
    - for chart in */; do helm lint "$chart"; done
  allow_failure: false

validate:kubernetes:
  stage: validate
  image: bitnami/kubectl:latest
  script:
    - kubectl apply --dry-run=client -f local/kubernetes/db/
    - kubectl apply --dry-run=client -f local/kubernetes/cache/
    - kubectl apply --dry-run=client -f local/kubernetes/queue/
  allow_failure: false

# Test
test:unit:
  stage: test
  image: node:20-alpine
  cache:
    paths:
      - node_modules/
  script:
    - npm ci
    - npm run test
    - npm run test:coverage
  coverage: '/Statements\s*:\s*(\d+\.\d+)%/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
    paths:
      - coverage/
    expire_in: 30 days

test:integration:
  stage: test
  image: node:20-alpine
  services:
    - postgres:16-alpine
    - redis:7-alpine
  variables:
    POSTGRES_DB: testdb
    POSTGRES_USER: test
    POSTGRES_PASSWORD: test
    REDIS_HOST: redis
  script:
    - npm ci
    - npm run test:integration
  allow_failure: false

# Security
security:trivy:
  stage: security
  image: aquasec/trivy:latest
  script:
    - trivy fs --exit-code 0 --no-progress .
    - trivy fs --exit-code 1 --severity CRITICAL --no-progress .
  allow_failure: false

security:npm-audit:
  stage: security
  image: node:20-alpine
  script:
    - npm audit --audit-level=moderate
  allow_failure: true

security:sonarqube:
  stage: security
  image: sonarsource/sonar-scanner-cli:latest
  variables:
    SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"
    GIT_DEPTH: "0"
  cache:
    key: "${CI_JOB_NAME}"
    paths:
      - .sonar/cache
  script:
    - sonar-scanner
      -Dsonar.projectKey=$CI_PROJECT_NAME
      -Dsonar.sources=.
      -Dsonar.host.url=$SONAR_HOST_URL
      -Dsonar.login=$SONAR_TOKEN
  only:
    - main
    - master
    - develop

# Build
build:docker:
  stage: build
  image: docker:24-dind
  services:
    - docker:24-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build -t $IMAGE:$CI_COMMIT_SHORT_SHA .
    - docker build -t $IMAGE:latest .
    - docker push $IMAGE:$CI_COMMIT_SHORT_SHA
    - docker push $IMAGE:latest
  only:
    - main
    - master
    - develop
  artifacts:
    reports:
      dotenv: build.env

build:helm-package:
  stage: build
  image: alpine/helm:latest
  script:
    - cd local/helm-charts
    - for chart in */; do
        helm package "$chart" -d packages/;
      done
  artifacts:
    paths:
      - local/helm-charts/packages/
    expire_in: 30 days
  only:
    - main
    - master

# Deploy Development
deploy:dev:k8s:
  stage: deploy-dev
  image: bitnami/kubectl:latest
  <<: *kubectl_config
  script:
    - cd local/kubernetes
    - ./deploy.sh --all
  environment:
    name: development
    url: https://dev.example.com
  only:
    - develop
  when: manual

deploy:dev:helm:
  stage: deploy-dev
  image: alpine/helm:latest
  <<: *helm_config
  script:
    - cd local/helm-charts
    - ./deploy-all.sh --all --env dev
  environment:
    name: development
    url: https://dev.example.com
  only:
    - develop
  when: manual

deploy:dev:helmfile:
  stage: deploy-dev
  image: alpine/helm:latest
  <<: *helm_config
  before_script:
    - apk add --no-cache curl
    - curl -L https://github.com/local/helmfile/local/helmfile/releases/download/v0.159.0/helmfile_linux_amd64 -o /usr/local/bin/helmfile
    - chmod +x /usr/local/bin/helmfile
    - helm plugin install https://github.com/databus23/helm-diff || true
    - mkdir -p $(dirname $KUBECONFIG)
    - echo "$KUBE_CONFIG" | base64 -d > $KUBECONFIG
  script:
    - cd local/helmfile
    - helmfile -e dev diff
    - helmfile -e dev apply
  environment:
    name: development
    url: https://dev.example.com
  only:
    - develop
  when: manual

# Deploy Staging
deploy:staging:helmfile:
  stage: deploy-staging
  image: alpine/helm:latest
  <<: *helm_config
  before_script:
    - apk add --no-cache curl
    - curl -L https://github.com/local/helmfile/local/helmfile/releases/download/v0.159.0/helmfile_linux_amd64 -o /usr/local/bin/helmfile
    - chmod +x /usr/local/bin/helmfile
    - helm plugin install https://github.com/databus23/helm-diff || true
    - mkdir -p $(dirname $KUBECONFIG)
    - echo "$KUBE_CONFIG_STAGING" | base64 -d > $KUBECONFIG
  script:
    - cd local/helmfile
    - helmfile -e uat diff
    - helmfile -e uat apply
  environment:
    name: staging
    url: https://staging.example.com
  only:
    - main
    - master
  when: manual

# Deploy Production
deploy:production:helmfile:
  stage: deploy-production
  image: alpine/helm:latest
  <<: *helm_config
  before_script:
    - apk add --no-cache curl
    - curl -L https://github.com/local/helmfile/local/helmfile/releases/download/v0.159.0/helmfile_linux_amd64 -o /usr/local/bin/helmfile
    - chmod +x /usr/local/bin/helmfile
    - helm plugin install https://github.com/databus23/helm-diff || true
    - mkdir -p $(dirname $KUBECONFIG)
    - echo "$KUBE_CONFIG_PROD" | base64 -d > $KUBECONFIG
  script:
    - cd local/helmfile
    - helmfile -e production diff
    - helmfile -e production apply --wait
  environment:
    name: production
    url: https://app.example.com
  only:
    - main
    - master
  when: manual
  needs:
    - deploy:staging:helmfile

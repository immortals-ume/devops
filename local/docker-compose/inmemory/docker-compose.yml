version: '3.9'

services:
  # H2 Database
  h2:
    image: oscarfonts/h2:2.2.224
    container_name: h2_inmemory
    ports:
      - "8082:8082"
      - "9092:9092"
    environment:
      H2_OPTIONS: -tcp -tcpAllowOthers -tcpPort 9092 -web -webAllowOthers -webPort 8082
    volumes:
      - h2_data:/opt/h2-data
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8082"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 20s
    restart: unless-stopped
    networks:
      - inmemory
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # Apache Ignite
  ignite:
    image: apacheignite/ignite:2.16.0
    container_name: ignite_inmemory
    ports:
      - "10800:10800"
      - "11211:11211"
      - "47100:47100"
      - "47500:47500"
    environment:
      IGNITE_QUIET: "false"
      JVM_OPTS: "-Xms512m -Xmx1g"
    volumes:
      - ignite_data:/opt/ignite/work
      - ./ignite_config.xml:/opt/ignite/config/ignite-config.xml:ro
    command: /opt/ignite/bin/ignite.sh /opt/ignite/config/ignite-config.xml
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/ignite?cmd=version"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s
    restart: unless-stopped
    networks:
      - inmemory
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # Hazelcast
  hazelcast:
    image: hazelcast/hazelcast:5.3
    container_name: hazelcast_inmemory
    ports:
      - "5701:5701"
    environment:
      JAVA_OPTS: "-Xms512m -Xmx1g"
      HZ_CLUSTERNAME: ${HZ_CLUSTER_NAME:-dev}
    volumes:
      - hazelcast_data:/data
      - ./hazelcast.yaml:/opt/hazelcast/config/hazelcast.yaml:ro
    command: hz start -c /opt/hazelcast/config/hazelcast.yaml
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5701/hazelcast/health/ready"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    restart: unless-stopped
    networks:
      - inmemory
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # Memcached
  memcached:
    image: memcached:1.6-alpine
    container_name: memcached_inmemory
    ports:
      - "11212:11211"
    command: memcached -m 512 -c 1024 -v
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "11211"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    networks:
      - inmemory
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  h2_data:
    driver: local
  ignite_data:
    driver: local
  hazelcast_data:
    driver: local

networks:
  inmemory:
    driver: bridge
